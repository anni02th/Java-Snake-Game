name: "Test ML API and Build"

# Allows you to run this workflow manually from the Actions tab
on: [workflow_dispatch]

jobs:
  test_predict_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: "1. Checkout Full History"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for feature collection

      - name: "2. Set up Python 3.10"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: "3. Install Dependencies"
        run: |
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq
        
      - name: "4. Run ML Model Prediction"
        id: predict_step
        env:
          # Uses the secret you updated in Step 1
          PREDICTION_API_URL: ${{ secrets.PREDICTION_API_URL }} 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ Calling ML API at: $PREDICTION_API_URL"
          python scripts/predict_realtime.py
          
          if [ ! -f prediction.txt ]; then
            echo "‚ùå prediction.txt not found! The script failed." >&2
            exit 1
          fi
          
          PRED_RESULT=$(cat prediction.txt)
          echo "API Result: $PRED_RESULT"
          echo "result=$PRED_RESULT" >> "$GITHUB_OUTPUT"

      - name: "5. Prepare Comment Body"
        id: prep_comment
        env:
          ML_PREDICTION: ${{ steps.predict_step.outputs.result }}
        run: |
          echo "### üîÆ ML API Test Results" > body.txt
          echo "" >> body.txt
          echo "| Model | Prediction |" >> body.txt
          echo "|---|---|" >> body.txt
          echo "| ü§ñ **ML Model** | \`$ML_PREDICTION\` |" >> body.txt
          
          {
            echo 'BODY_CONTENT<<EOF'
            cat body.txt
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: "6. Post Prediction as a Commit Comment"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="$BODY_CONTENT"

      - name: "7. Set up JDK and Build"
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
        
      - name: "8. Run Maven Build"
        run: ./mvnw package

      - name: "9. Send Email on Failure"
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå ML API Test Workflow Failed: ${{ github.repository }}"
          to: ${{ secrets.MAIL_RECEIVER }}
          from: GitHub Actions Notifier <${{ secrets.MAIL_USERNAME }}>
          body: "The test workflow for the ML API failed. Check the logs."