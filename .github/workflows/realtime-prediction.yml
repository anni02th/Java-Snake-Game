name: "Build Failure Prediction"

on: [push]

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_predict: ${{ steps.check_files.outputs.should_predict }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with: { fetch-depth: 2 }

      - name: Check for Code Changes
        id: check_files
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE "\.(java|xml|properties|yml|yaml|pom)$"; then
            echo "Code files were changed. Prediction is required."
            echo "should_predict=true" >> "$GITHUB_OUTPUT"
          else
            echo "No code files changed. Skipping prediction."
            echo "should_predict=false" >> "$GITHUB_OUTPUT"
          fi

  predict_models:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    strategy:
      matrix:
        model: [ml_model, gen_ai]
    outputs:
      ml_prediction: ${{ steps.predict_step.outputs.result }}
      genai_prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - name: Checkout Full History
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.10' }

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq

      - name: Run Model Prediction
        id: predict_step
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PREDICTION_API_URL: ${{ matrix.model == 'ml_model' && secrets.PREDICTION_API_URL || secrets.GEN_AI_API_URL }}
        run: |
          if [ -z "$PREDICTION_API_URL" ]; then
            echo "Error: PREDICTION_API_URL not set!" >&2
            exit 1
          fi

          python scripts/predict_realtime.py

          if [ ! -f prediction.txt ]; then
            echo "Error: prediction.txt not found!" >&2
            exit 1
          fi

          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"

      - name: Archive Payload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.model }}-payload
          path: payload.json

  notify-and-build:
    runs-on: ubuntu-latest
    needs: [check_changes, predict_models]
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download ML Payload
        if: needs.check_changes.outputs.should_predict == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ml_model-payload
          path: ./ml

      - name: Download GenAI Payload
        if: needs.check_changes.outputs.should_predict == 'true'
        uses: actions/download-artifact@v4
        with:
          name: gen_ai-payload
          path: ./genai

      - name: Get Explanation from GenAI (if ML predicts failure)
        id: get_explanation
        if: needs.predict_models.outputs.ml_prediction == 'Fail'
        env:
          EXPLAIN_API_URL: ${{ secrets.GEN_AI_API_URL }}/explain
        run: |
          EXPLANATION=$(curl -fsS -X POST -H "Content-Type: application/json" --data @./ml/payload.json "$EXPLAIN_API_URL" | jq -r .explanation)
          echo "explanation=$EXPLANATION" >> "$GITHUB_OUTPUT"

      - name: Prepare Comment Body
        id: prep_comment
        env:
          SHOULD_PREDICT: ${{ needs.check_changes.outputs.should_predict }}
          ML_PREDICTION: ${{ needs.predict_models.outputs.ml_prediction }}
          GEN_AI_PREDICTION: ${{ needs.predict_models.outputs.genai_prediction }}
          AI_EXPLANATION: ${{ steps.get_explanation.outputs.explanation }}
        run: |
          if [ "$SHOULD_PREDICT" == "false" ]; then
            BODY="‚úÖ **Trivial Change Detected**"$'\n\n'"No code files were modified. Skipping build failure prediction."
          else
            BODY="**Build Failure Prediction Results**"$'\n\n'"- ü§ñ ML Model: \`${ML_PREDICTION:-Error}\`"$'\n'"- üß† GenAI Model: \`${GEN_AI_PREDICTION:-Error}\`"
            if [ "$ML_PREDICTION" == "Fail" ]; then
              BODY+="$'\n\n'**ML Model Explanation**: _${AI_EXPLANATION:-Unable to get explanation from the GenAI model.}_"
            fi
          fi

          echo 'BODY_CONTENT<<EOF' >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Post Prediction as a Commit Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="$BODY_CONTENT"

      - name: Set up JDK and Build
        uses: actions/setup-java@v3
        with: { java-version: '17', distribution: 'temurin' }

      - name: Run Maven Build
        run: ./mvnw package

      - name: Send Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Workflow Failed: ${{ github.workflow }} in ${{ github.repository }}"
          to: ${{ secrets.MAIL_RECEIVER }}
          from: GitHub Actions Notifier <${{ secrets.MAIL_USERNAME }}>
          body: |
            The '${{ github.workflow }}' workflow in repository '${{ github.repository }}' has failed.
            **Commit**: ${{ github.sha }}
            **Triggered by**: ${{ github.actor }}
            Please review the full logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
