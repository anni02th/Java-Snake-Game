name: "Build Failure Prediction"

on: [push]

jobs:
  # JOB 1: Check if the changes are worth predicting
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_predict: ${{ steps.check_files.outputs.should_predict }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 2 }

      - name: "Check for Code Changes"
        id: check_files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          CODE_EXTENSIONS_REGEX="\.(java|xml|properties|yml|yaml|pom)$"
          
          if echo "$CHANGED_FILES" | grep -qE "$CODE_EXTENSIONS_REGEX"; then
            echo "should_predict=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_predict=false" >> "$GITHUB_OUTPUT"
          fi

  # JOB 2 & 3 (Parallel): Run Predictions
  predict_ml_model:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - run: pip install pandas requests numpy
      - name: "Run ML Model Prediction"
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.PREDICTION_API_URL }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat payload.json | jq -r .prediction)" >> "$GITHUB_OUTPUT"
      - name: "Archive Payload for Tracking"
        uses: actions/upload-artifact@v4
        with:
          name: ml-payload
          path: payload.json
          
  predict_gen_ai:
    # ... (this job is structured identically to predict_ml_model but uses GEN_AI_API_URL)
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - run: pip install pandas requests numpy
      - name: "Run GenAI Model Prediction"
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.GEN_AI_API_URL }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat payload.json | jq -r .prediction)" >> "$GITHUB_OUTPUT"
      - name: "Archive Payload for Tracking"
        uses: actions/upload-artifact@v4
        with:
          name: genai-payload
          path: payload.json


  # JOB 4: Combine results, get explanation, notify, and build
  notify-and-build:
    runs-on: ubuntu-latest
    needs: [check_changes, predict_ml_model, predict_gen_ai]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: "Download Payloads for Explanation"
        if: needs.check_changes.outputs.should_predict == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ml-payload # We only need one payload
          path: .
      - name: "Get AI Explanation on Failure"
        id: get_explanation
        if: needs.predict_ml_model.outputs.prediction == 'Fail'
        env:
          EXPLAIN_API_URL: ${{ secrets.GEN_AI_API_URL }}/explain # Append /explain to the URL
        run: |
          EXPLANATION=$(curl -s -X POST -H "Content-Type: application/json" --data @payload.json "$EXPLAIN_API_URL" | jq -r .explanation)
          echo "explanation=$EXPLANATION" >> "$GITHUB_OUTPUT"

      - name: "ðŸ“¬ Post Prediction as a Commit Comment"
        id: post_comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHOULD_PREDICT: ${{ needs.check_changes.outputs.should_predict }}
          ML_PREDICTION: ${{ needs.predict_ml_model.outputs.prediction }}
          GEN_AI_PREDICTION: ${{ needs.predict_gen_ai.outputs.prediction }}
          AI_EXPLANATION: ${{ steps.get_explanation.outputs.explanation }}
        run: |
          # Use jq to safely build the JSON payload with newlines
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          if [ "$SHOULD_PREDICT" == "false" ]; then
            BODY="âœ… **Trivial Change Detected**\n\nNo code files were modified. Skipping build failure prediction."
          else
            BODY="**Build Failure Prediction Results**\n\n- ðŸ¤– ML Model: \`${ML_PREDICTION:-Not Run}\`\n- ðŸ§  GenAI Model: \`${GEN_AI_PREDICTION:-Not Run}\`"
            if [ "${{ needs.predict_ml_model.outputs.prediction }}" == "Fail" ]; then
              BODY+="\n\n**AI Explanation**: _${AI_EXPLANATION:-Unable to get explanation.}_"
            fi
          fi
          
          # This is the robust way to create the comment body
          JSON_PAYLOAD=$(jq -n --arg body "$BODY" '{body: $body}')

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            --input - <<< "$JSON_PAYLOAD"

      - name: "Set up JDK and Build"
        # ... (build steps are the same)
        uses: actions/setup-java@v3
        with: { java-version: '17', distribution: 'temurin' }
      - run: ./mvnw package

      - name: "ðŸ“§ Send Email on Failure"
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "GitHub Actions workflow failed: ${{ github.workflow }}"
          to: ${{ secrets.MAIL_RECEIVER }}
          from: GitHub Actions Notifier <${{ secrets.MAIL_USERNAME }}>
          body: |
            The '${{ github.workflow }}' workflow in the repository '${{ github.repository }}' has failed.
            
            Commit: ${{ github.sha }}
            
            Please review the logs for more details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
