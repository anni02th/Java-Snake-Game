name: "Build Failure Prediction"

on: [push]

jobs:
  # JOB 1: Check for meaningful code changes
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_predict: ${{ steps.check_files.outputs.should_predict }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with: { fetch-depth: 2 }
      - name: Check for Code Changes
        id: check_files
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE "\.(java|xml|properties|yml|yaml|pom)$"; then
            echo "Code files were changed. Prediction is required."
            echo "should_predict=true" >> "$GITHUB_OUTPUT"
          else
            echo "No code files changed. Skipping prediction."
            echo "should_predict=false" >> "$GITHUB_OUTPUT"
          fi

  # JOB 2: Predict using the ML model
  ml-api:
    name: "1. Run ML Prediction"
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - name: Checkout Full History
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Cache Python Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Dependencies
        run: |
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq
      - name: Run ML Model Prediction
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.PREDICTION_API_URL }} # ML Model URL
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"
      - name: Archive ML Payload
        uses: actions/upload-artifact@v4
        with:
          name: ml-payload
          path: payload.json

  # JOB 3: Predict using the GenAI model
  gen-ai-api:
    name: "2. Run GenAI Prediction"
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - name: Checkout Full History
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Dependencies
        run: |
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq
      - name: Run GenAI Model Prediction
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.GEN_AI_API_URL }}/predict # GenAI /predict URL
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"
      - name: Archive GenAI Payload
        uses: actions/upload-artifact@v4
        with:
          name: genai-payload # Use a different name
          path: payload.json

  # JOB 4: Combine, Report, and Build
  notify-and-build:
    name: "3. Report, Log, and Build"
    runs-on: ubuntu-latest
    needs: [check_changes, ml-api, gen-ai-api]
    if: always() # This job runs even if predictions were skipped
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Download Payloads
        if: needs.check_changes.outputs.should_predict == 'true'
        uses: actions/download-artifact@v4
        with:
          name: genai-payload # Use the payload from GenAI
          path: .
          
      - name: Get AI Explanation on Failure
        id: get_explanation
        if: |
          needs.check_changes.outputs.should_predict == 'true' &&
          needs.ml-api.outputs.prediction == 'Fail'
        env:
          EXPLAIN_API_URL: ${{ secrets.GEN_AI_API_URL }}/explain
        run: |
          echo "ML model predicted failure. Attempting to get explanation..."
          
          # CRITICAL FIX: Removed the '-f' (fail-fast) flag from curl to capture the 500 response body.
          # We capture the full JSON response, and use jq to extract the 'report' or the 'detail' error message.
          
          RESPONSE_BODY=$(curl -sS -X POST -H "Content-Type: application/json" \
            --data @payload.json "$EXPLAIN_API_URL" || echo '{"report": "CURL_FAILURE", "detail": "CURL_ERROR_OCCURRED"}')
            
          # Extracts the 'report' field if successful, otherwise extracts the 'detail' (the error message)
          # 'jq' syntax: .report // .detail tries the first field, then the second, then defaults to the string.
          EXPLANATION=$(echo "$RESPONSE_BODY" | jq -r '.report // .detail // "Unknown error: check Cloud Run logs."')

          echo "explanation<<EOF" >> "$GITHUB_OUTPUT"
          echo "$EXPLANATION" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Log Data to Dashboard
        if: needs.check_changes.outputs.should_predict == 'true'
        env:
          LOG_API_URL: ${{ secrets.GEN_AI_API_URL }}/log_commit
          ML_PREDICTION: ${{ needs.ml-api.outputs.prediction }}
          GEN_AI_PREDICTION: ${{ needs.gen-ai-api.outputs.prediction }}
          AI_EXPLANATION: ${{ steps.get_explanation.outputs.explanation }}
        run: |
          # Use 'jq' to create the final JSON payload
          JSON_TO_SEND=$(jq -n \
            --arg sha "${{ github.sha }}" \
            --arg msg "$(git log -1 --pretty=%s)" \
            --arg author "$(git log -1 --pretty=%an)" \
            --arg ml_pred "${ML_PREDICTION:-Error}" \
            --arg genai_pred "${GEN_AI_PREDICTION:-Error}" \
            --arg explanation "${AI_EXPLANATION:-N/A}" \
            --argjson payload "$(cat payload.json || echo 'null')" \
            '{
              commit_sha: $sha,
              commit_message: $msg,
              commit_author: $author,
              ml_prediction: $ml_pred,
              genai_prediction: $genai_pred,
              ai_explanation: $explanation,
              feature_payload: $payload
            }')
          
          echo "Sending log data to dashboard..."
          curl -X POST -H "Content-Type: application/json" \
            --data "$JSON_TO_SEND" \
            "$LOG_API_URL"

      - name: Prepare Comment Body
        id: prep_comment
        env:
          SHOULD_PREDICT: ${{ needs.check_changes.outputs.should_predict }}
          ML_PREDICTION: ${{ needs.ml-api.outputs.prediction }}
          GEN_AI_PREDICTION: ${{ needs.gen-ai-api.outputs.prediction }}
          AI_EXPLANATION: ${{ steps.get_explanation.outputs.explanation }}
        run: |
          if [ "$SHOULD_PREDICT" == "false" ]; then
            echo "‚úÖ **Trivial Change Detected**" > body.txt
            echo "" >> body.txt
            echo "No code files were modified. Skipping build failure prediction." >> body.txt
          else
            ML_RESULT="${ML_PREDICTION:-Skipped/Error}"
            AI_RESULT="${GEN_AI_PREDICTION:-Skipped/Error}"
            echo "### üîÆ Build Failure Prediction Results" > body.txt
            echo "" >> body.txt
            echo "| Model | Prediction |" >> body.txt
            echo "|---|---|" >> body.txt
            echo "| ü§ñ **ML Model** | \`$ML_RESULT\` |" >> body.txt
            echo "| üß† **GenAI Model** | \`$AI_RESULT\` |" >> body.txt
            if [ "$ML_RESULT" == "Fail" ]; then
              EXPLANATION="${AI_EXPLANATION:-Unable to get explanation from the GenAI model.}"
              echo "" >> body.txt
              echo "**AI Explanation**: _${EXPLANATION}_" >> body.txt
            fi
          fi
          {
            echo 'BODY_CONTENT<<EOF'
            cat body.txt
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Post Prediction as a Commit Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="$BODY_CONTENT"

      - name: Set up JDK and Build
        uses: actions/setup-java@v3
        with: { java-version: '17', distribution: 'temurin' }
        
      - name: Send Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Workflow Failed: ${{ github.workflow }} in ${{ github.repository }}"
          to: ${{ secrets.MAIL_RECEIVER }}
          from: GitHub Actions Notifier <${{ secrets.MAIL_USERNAME }}>
          body: |
            The '${{ github.workflow }}' workflow in repository '${{ github.repository }}' has failed.