name: "Build Failure Prediction"

on: [push]

jobs:
  # JOB 1: Check for meaningful code changes
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_predict: ${{ steps.check_files.outputs.should_predict }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with: { fetch-depth: 2 }

      - name: Check for Code Changes
        id: check_files
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE "\.(java|xml|properties|yml|yaml|pom)$"; then
            echo "Code files were changed. Prediction is required."
            echo "should_predict=true" >> "$GITHUB_OUTPUT"
          else
            echo "No code files changed. Skipping prediction."
            echo "should_predict=false" >> "$GITHUB_OUTPUT"
          fi

  # JOB 2: Predict using the Machine Learning model
  predict_ml_model:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - name: Checkout Full History
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      
      - name: Cache Python Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install Dependencies
        run: |
          # FIXED: Using the correct path to your requirements file
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq
          
      - name: Run ML Model Prediction
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.PREDICTION_API_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"
          
      - name: Archive Payload for Tracking
        uses: actions/upload-artifact@v4
        with:
          name: ml-payload
          path: payload.json

  # JOB 3: Predict using the Generative AI (Gemini) model
  predict_gen_ai:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - name: Checkout Full History
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          # FIXED: Using the correct path to your requirements file
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq
          
      - name: Run GenAI Model Prediction
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.GEN_AI_API_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"
          
      - name: Archive Payload for Tracking
        uses: actions/upload-artifact@v4
        with:
          name: genai-payload
          path: payload.json

  # JOB 4: Combine results, get explanation, notify, and build
  notify-and-build:
    runs-on: ubuntu-latest
    needs: [check_changes, predict_ml_model, predict_gen_ai]
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Download Payloads for Explanation
        if: needs.check_changes.outputs.should_predict == 'true'
        uses: actions/download-artifact@v4
        with:
          name: ml-payload
          path: .
      - name: Get AI Explanation on Failure
        id: get_explanation
        if: needs.predict_ml_model.outputs.prediction == 'Fail'
        env:
          EXPLAIN_API_URL: ${{ secrets.GEN_AI_API_URL }}/explain
        run: |
          EXPLANATION=$(curl -fsS -X POST -H "Content-Type: application/json" --data @payload.json "$EXPLAIN_API_URL" | jq -r .explanation)
          echo "explanation=$EXPLANATION" >> "$GITHUB_OUTPUT"

      - name: Prepare Comment Body
        id: prep_comment
        env:
          SHOULD_PREDICT: ${{ needs.check_changes.outputs.should_predict }}
          ML_PREDICTION: ${{ needs.predict_ml_model.outputs.prediction }}
          GEN_AI_PREDICTION: ${{ needs.predict_gen_ai.outputs.prediction }}
          AI_EXPLANATION: ${{ steps.get_explanation.outputs.explanation }}
        run: |
          if [ "$SHOULD_PREDICT" == "false" ]; then
            BODY="‚úÖ **Trivial Change Detected**"$'\n\n'"No code files were modified. Skipping build failure prediction."
          else
            ML_RESULT="${{ needs.predict_ml_model.outputs.prediction }}"
            AI_RESULT="${{ needs.predict_gen_ai.outputs.prediction }}"
            BODY="**Build Failure Prediction Results**"$'\n\n'"- ü§ñ ML Model: \`${ML_RESULT:-Error}\`"$'\n'"- üß† GenAI Model: \`${AI_RESULT:-Error}\`"
            if [ "$ML_RESULT" == "Fail" ]; then
              EXPLANATION="${{ steps.get_explanation.outputs.explanation }}"
              BODY+="$'\n\n'"**AI Explanation**: _${AI_EXPLANATION:-Unable to get explanation from the GenAI model.}_"
            fi
          fi
          echo 'BODY_CONTENT<<EOF' >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Post Prediction as a Commit Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="$BODY_CONTENT"

      - name: Set up JDK and Build
        uses: actions/setup-java@v3
        with: { java-version: '17', distribution: 'temurin' }
        
      - name: Run Maven Build
        run: ./mvnw package

      - name: Send Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Workflow Failed: ${{ github.workflow }} in ${{ github.repository }}"
          to: ${{ secrets.MAIL_RECEIVER }}
          from: GitHub Actions Notifier <${{ secrets.MAIL_USERNAME }}>
          body: |
            The '${{ github.workflow }}' workflow in repository '${{ github.repository }}' has failed.
            **Commit**: ${{ github.sha }}
            **Triggered by**: ${{ github.actor }}
            Please review the full logs for more details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}