name: "Build Failure Prediction"

on: [push]

jobs:
  # JOB 1: Check for meaningful code changes
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_predict: ${{ steps.check_files.outputs.should_predict }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with: { fetch-depth: 2 }

      - name: Check for Code Changes
        id: check_files
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE "\.(java|xml|properties|yml|yaml|pom)$"; then
            echo "should_predict=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_predict=false" >> "$GITHUB_OUTPUT"
          fi

  # JOB 2: Predict using the Machine Learning model
  predict_ml_model:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }} # Assuming requirements are in scripts/
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Dependencies
        run: |
          pip install -r scripts/requirements.txt # Assuming requirements are in scripts/
          sudo apt-get update && sudo apt-get install -y cloc jq
      - name: Run ML Model Prediction
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.PREDICTION_API_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with: { name: ml-payload, path: payload.json }

  # JOB 3: Predict using the Generative AI (Gemini) model
  predict_gen_ai:
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.should_predict == 'true'
    outputs:
      prediction: ${{ steps.predict_step.outputs.result }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Dependencies
        run: |
          pip install -r scripts/requirements.txt
          sudo apt-get update && sudo apt-get install -y cloc jq
      - name: Run GenAI Model Prediction
        id: predict_step
        env:
          PREDICTION_API_URL: ${{ secrets.GEN_AI_API_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/predict_realtime.py
          echo "result=$(cat prediction.txt)" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with: { name: genai-payload, path: payload.json }

  # JOB 4: Combine results, get explanation, notify, and build
  notify-and-build:
    runs-on: ubuntu-latest
    needs: [check_changes, predict_ml_model, predict_gen_ai]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        if: needs.check_changes.outputs.should_predict == 'true'
        with: { name: ml-payload, path: . }
      - name: Get AI Explanation on Failure
        id: get_explanation
        if: needs.predict_ml_model.outputs.prediction == 'Fail'
        env:
          EXPLAIN_API_URL: ${{ secrets.GEN_AI_API_URL }}/explain
        run: |
          EXPLANATION=$(curl -fsS -X POST -H "Content-Type: application/json" --data @payload.json "$EXPLAIN_API_URL" | jq -r .explanation)
          echo "explanation=$EXPLANATION" >> "$GITHUB_OUTPUT"

      - name: Post Prediction as a Commit Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHOULD_PREDICT: ${{ needs.check_changes.outputs.should_predict }}
          ML_PREDICTION: ${{ needs.predict_ml_model.outputs.prediction }}
          GEN_AI_PREDICTION: ${{ needs.predict_gen_ai.outputs.prediction }}
          AI_EXPLANATION: ${{ steps.get_explanation.outputs.explanation }}
        run: |
          # ROBUST FIX: Use a here-document (EOF) to handle multi-line strings and special characters
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          
          if [ "$SHOULD_PREDICT" == "false" ]; then
            BODY="âœ… **Trivial Change Detected**\n\nNo code files were modified. Skipping build failure prediction."
          else
            ML_RESULT="${{ needs.predict_ml_model.outputs.prediction }}"
            AI_RESULT="${{ needs.predict_gen_ai.outputs.prediction }}"
            BODY="**Build Failure Prediction Results**\n\n- ðŸ¤– ML Model: \`${ML_RESULT:-Error}\`\n- ðŸ§  GenAI Model: \`${AI_RESULT:-Error}\`"
            if [ "$ML_RESULT" == "Fail" ]; then
              EXPLANATION="${{ steps.get_explanation.outputs.explanation }}"
              BODY+="\n\n**AI Explanation**: _${AI_EXPLANATION:-Unable to get explanation from the GenAI model.}_"
            fi
          fi

          JSON_PAYLOAD=$(jq -n --arg body "$BODY" '{body: $body}')
          
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/comments \
            --input - <<< "$JSON_PAYLOAD"

      - name: Set up JDK and Build
        uses: actions/setup-java@v3
        with: { java-version: '17', distribution: 'temurin' }
      - run: ./mvnw package

      - name: Send Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ Build Failure Prediction FAILED for ${{ github.repository }}"
          to: ${{ secrets.MAIL_RECEIVER }}
          from: GitHub Actions Notifier <${{ secrets.MAIL_USERNAME }}>
          # IMPROVEMENT: Add more details to the email body
          body: |
            The '${{ github.workflow }}' workflow in the repository '${{ github.repository }}' has failed.

            **Commit**: `${{ github.sha }}`
            **Author**: `${{ github.actor }}`
            **Triggered by**: `${{ github.event_name }}`

            A step in the 'notify-and-build' job failed. Please review the logs immediately for details.
            
            **Direct Link to Logs**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}